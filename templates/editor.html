<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Project Manager Chat</title>
    <style>
      body { 
        font-family: sans-serif; 
        margin: 0; 
        padding: 0; 
        background-color: #2e2e2e; 
        color: #f0f0f0;
        height: 100vh;
        overflow: hidden;
      }
      #container {
        display: flex;
        height: 100%;
        width: 100%;
      }
      /* Left Column - Project Browser */
      #projectBrowser {
        width: 20%;
        min-width: 200px;
        border-right: 1px solid #444;
        padding: 10px;
        box-sizing: border-box;
        overflow-y: auto;
        position: relative;
      }
      #projectBrowser h2 {
        color: #fff;
      }
      /* New File Button */
      #newFileBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        background-color: #4CAF50;
        border: none;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
      }
      /* Modal Styles */
      .modal {
        display: none; 
        position: fixed; 
        z-index: 1; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.4); 
      }
      .modal-content {
        background-color: #333;
        margin: 15% auto; 
        padding: 20px;
        border: 1px solid #888;
        width: 300px; 
        border-radius: 5px;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close:hover,
      .close:focus {
        color: #fff;
        text-decoration: none;
      }
      /* Middle Column - Active Coding Contexts, Tabs, Source Code Editor and Chat */
      #mainContent {
        width: 60%;
        display: flex;
        flex-direction: column;
        padding: 10px;
        box-sizing: border-box;
        overflow: hidden;
      }
      /* Active Coding Contexts */
      #activeCodingContextsContainer {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 10px;
      }
      #activeCodingContexts {
        display: flex;
        flex-wrap: wrap;
      }
      .badge {
        display: inline-block;
        padding: 5px 10px;
        margin: 2px;
        background-color: #4CAF50;
        border-radius: 12px;
        font-size: 12px;
        cursor: pointer;
      }
      /* Tabs */
      #tabs {
        display: flex;
        border-bottom: 1px solid #444;
        margin-bottom: 10px;
      }
      .tab {
        padding: 10px;
        cursor: pointer;
        background-color: #3c3c3c;
        margin-right: 2px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
      }
      .tab.active {
        background-color: #1e1e1e;
        border-bottom: 1px solid #1e1e1e;
      }
      .close-btn {
        margin-left: 5px;
        color: #f44336;
        font-weight: bold;
        cursor: pointer;
      }
      /* Source Code Editor */
      #sourceCodeContainer {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
        overflow: auto;
      }
      #sourceCodeContainer h2 {
        color: #fff;
        margin-bottom: 5px;
      }
      /* CodeMirror styles override */
      .CodeMirror {
        flex: 1;
        height: auto;
        background-color: #1e1e1e;
        color: #d4d4d4;
        border: 1px solid #444;
        border-radius: 4px;
      }
      /* Chat Container */
      #chatContainer {
        display: flex;
        flex-direction: column;
        max-height: 200px;
        flex-shrink: 0;
      }
      #chatBox {
        flex: 1;
        border: 1px solid #444;
        padding: 10px;
        overflow-y: auto;
        background-color: #1e1e1e;
        border-radius: 4px;
        max-height: 150px;
      }
      .message { margin-bottom: 10px; }
      .User { color: #4FC3F7; }
      .Assistant { color: #81C784; }
      /* CSS spinner */
      #throbber {
        display: none;
        width: 40px;
        height: 40px;
        border: 4px solid #ccc;
        border-top: 4px solid #333;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      /* Styles for commit summaries */
      #commitSummariesContainer {
        width: 20%;
        min-width: 200px;
        border-left: 1px solid #444;
        padding: 10px;
        box-sizing: border-box;
        background-color: #1e1e1e;
        overflow-y: auto;
      }
      #commitSummariesContainer h2 {
        color: #fff;
      }
      #commitSummaries {
        height: 100%;
        overflow-y: auto;
      }
      .commit-summary {
        margin-bottom: 10px;
        padding: 5px;
        border-bottom: 1px solid #555;
      }
      /* Dark mode adjustments */
      textarea, input[type="submit"] {
        background-color: #3c3c3c;
        color: #f0f0f0;
        border: 1px solid #555;
        border-radius: 4px;
      }
      textarea::placeholder {
        color: #bbb;
      }
      input[type="submit"] {
        padding: 10px;
        cursor: pointer;
        display: none;
      }
      form {
        display: flex;
        flex-direction: column;
      }
      /* Responsive adjustments */
      @media (max-width: 1200px) {
        #projectBrowser, #commitSummariesContainer {
          width: 25%;
        }
        #mainContent {
          width: 50%;
        }
      }
      @media (max-width: 800px) {
        #container {
          flex-direction: column;
        }
        #projectBrowser, #commitSummariesContainer {
          width: 100%;
          min-width: unset;
          height: 150px;
        }
        #mainContent {
          width: 100%;
          flex: 1;
        }
      }
      /* Styles for project browser tree */
      .directory, .file {
        /* Removed margin-left to ensure consistent alignment */
        padding-left: 20px;
      }
      .directory > span {
        cursor: pointer;
        font-weight: bold;
        position: relative;
        padding-left: 0;
      }
      .directory > span::before {
        content: '▶';
        position: absolute;
        left: -20px;
        transition: transform 0.2s;
        /* Positioned arrow in the gutter */
        width: 15px;
        text-align: center;
      }
      .directory > span.open::before {
        transform: rotate(90deg);
        content: '▶';
      }
      .hidden {
        display: none;
      }
      /* New File Modal Styles */
      .modal input[type="text"] {
        width: 100%;
        padding: 8px;
        margin-top: 10px;
        margin-bottom: 20px;
        box-sizing: border-box;
      }
      .modal button {
        padding: 8px 16px;
        background-color: #4CAF50;
        border: none;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
      }
      .modal button.cancel {
        background-color: #f44336;
        margin-left: 10px;
      }
    </style>
    <!-- Load Marked for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Load CodeMirror from CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <script>
      let activeFile = null;
      let openFiles = {};
      let editor = null;

      // Initialize CodeMirror editor
      function initializeCodeMirror() {
        const textarea = document.getElementById('sourceCode');
        editor = CodeMirror.fromTextArea(textarea, {
          mode: 'python',
          theme: 'dracula',
          lineNumbers: true,
          lineWrapping: true,
          tabSize: 4,
          indentUnit: 4,
          extraKeys: {
            "Ctrl-S": function(cm) {
              saveFile();
            }
          }
        });
      }

      // Save file function triggered by Ctrl+S
      function saveFile() {
        if (!activeFile) return;
        const updatedContent = editor.getValue();
        fetch('/update_source', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file: activeFile, content: updatedContent })
        })
        .then(response => response.json())
        .then(data => {
          if (data.message) {
            console.log(data.message);
          } else if (data.error) {
            console.error(data.error);
          }
        })
        .catch(error => {
          console.error('Error saving file:', error);
        });
      }

      // Render Markdown while escaping any raw HTML.
      function renderMarkdown(text) {
        const renderer = new marked.Renderer();
        renderer.html = function(html) {
          return String(html).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        };
        return marked.parse(text, {
          renderer: renderer,
          headerIds: false,
          mangle: false
        });
      }

      // Function to load project structure and set up event listeners for files
      async function loadProjectStructure() {
        try {
          const response = await fetch('/project_structure');
          if (response.ok) {
            const data = await response.json();
            const projectBrowser = document.getElementById('projectBrowser');
            projectBrowser.innerHTML = '<h2>Project Browser</h2>';
            // Add New File Button
            const newFileBtn = document.createElement('button');
            newFileBtn.id = 'newFileBtn';
            newFileBtn.textContent = 'New File';
            newFileBtn.addEventListener('click', openNewFileModal);
            projectBrowser.appendChild(newFileBtn);

            const treeContainer = document.createElement('div');
            createProjectTree(data, treeContainer);
            projectBrowser.appendChild(treeContainer);
          }
        } catch (e) {
          console.error('Error loading project structure:', e);
        }
      }

      // Function to create the project tree
      function createProjectTree(structure, parentElement, currentPath = '') {
        structure.forEach(item => {
          const itemDiv = document.createElement('div');
          if (item.type === 'directory') {
            const dirSpan = document.createElement('span');
            dirSpan.textContent = item.name;
            dirSpan.addEventListener('click', () => {
              childContainer.classList.toggle('hidden');
              dirSpan.classList.toggle('open');
            });
            itemDiv.className = 'directory';
            itemDiv.appendChild(dirSpan);
            const childContainer = document.createElement('div');
            childContainer.className = 'directory-children hidden';
            // Recursively create tree with updated path
            createProjectTree(item.children, childContainer, currentPath + item.name + '/');
            itemDiv.appendChild(childContainer);
          } else {
            const fileSpan = document.createElement('span');
            fileSpan.textContent = item.name;
            fileSpan.className = 'file';
            const fullPath = currentPath + item.name;
            fileSpan.addEventListener('click', () => {
              openFileInTab(fullPath);
            });
            itemDiv.appendChild(fileSpan);
          }
          parentElement.appendChild(itemDiv);
        });
      }

      // Function to open a file in a new tab
      async function openFileInTab(filename) {
        if (openFiles[filename]) {
          switchToTab(filename);
          return;
        }

        try {
          const response = await fetch(`/source?file=${encodeURIComponent(filename)}`);
          if (response.ok) {
            const data = await response.json();
            // Create a new tab
            const tabs = document.getElementById('tabs');
            const tab = document.createElement('div');
            tab.className = 'tab active';
            tab.id = `tab-${filename}`;
            tab.textContent = filename;
            const closeBtn = document.createElement('span');
            closeBtn.className = 'close-btn';
            closeBtn.textContent = '×';
            closeBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              closeTab(filename);
            });
            tab.appendChild(closeBtn);
            // Add event listener to switch tab on click
            tab.addEventListener('click', () => {
              switchToTab(filename);
            });
            // Deactivate other tabs
            Array.from(tabs.getElementsByClassName('tab')).forEach(t => {
              t.classList.remove('active');
            });
            tabs.appendChild(tab);
            // Load content into CodeMirror editor
            document.getElementById('sourceCode').value = data.content;
            if (editor) {
              editor.setValue(data.content);
            }
            activeFile = filename;
            openFiles[filename] = true;
            // Load transcript
            await loadTranscript(filename);
          }
        } catch (e) {
          console.error('Error opening file:', e);
        }
      }

      // Function to switch to an existing tab
      async function switchToTab(filename) {
        activeFile = filename;
        // Activate the selected tab
        const tabs = document.getElementById('tabs');
        Array.from(tabs.getElementsByClassName('tab')).forEach(t => {
          if (t.id === `tab-${filename}`) {
            t.classList.add('active');
          } else {
            t.classList.remove('active');
          }
        });
        // Load source code
        try {
          const response = await fetch(`/source?file=${encodeURIComponent(filename)}`);
          if (response.ok) {
            const data = await response.json();
            document.getElementById('sourceCode').value = data.content;
            if (editor) {
              editor.setValue(data.content);
            }
            // Load transcript
            await loadTranscript(filename);
          }
        } catch (e) {
          console.error('Error switching tabs:', e);
        }
      }

      // Function to close a tab
      function closeTab(filename) {
        const tab = document.getElementById(`tab-${filename}`);
        if (tab) {
          tab.parentNode.removeChild(tab);
          delete openFiles[filename];
          // If the closed tab was active, switch to another tab
          if (activeFile === filename) {
            const remainingTabs = document.getElementById('tabs').getElementsByClassName('tab');
            if (remainingTabs.length > 0) {
              const newActiveFilename = remainingTabs[remainingTabs.length - 1].id.replace('tab-', '');
              switchToTab(newActiveFilename);
            } else {
              activeFile = null;
              document.getElementById('sourceCode').value = '';
              if (editor) {
                editor.setValue('');
              }
              document.getElementById('chatBox').innerHTML = '';
              document.getElementById('commitSummaries').innerHTML = '';
              document.getElementById('activeCodingContexts').innerHTML = '';
            }
          }
        }
      }

      // Append a message to chatBox; content is rendered as Markdown.
      function appendMessage(role, content) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message';
        msgDiv.innerHTML = '<strong class="' + role + '">' + role + ':</strong><div>' + renderMarkdown(content) + '</div>';
        chatBox.appendChild(msgDiv);
      }

      // Append a commit summary to commitSummaries
      function appendCommitSummary(summary) {
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'commit-summary';
        summaryDiv.textContent = summary;
        commitSummaries.appendChild(summaryDiv);
      }

      // Append a coding context badge to activeCodingContexts
      function appendCodingContext(context) {
        if (!context || !context.name) return;
        const badgeSpan = document.createElement('span');
        badgeSpan.className = 'badge';
        badgeSpan.textContent = context.name;
        if (context.content) {
          badgeSpan.title = context.content; // Tooltip with full content
        }
        activeCodingContexts.appendChild(badgeSpan);
      }

      // Scroll to the bottom of an element.
      function scrollToBottom(element) {
        element.scrollTop = element.scrollHeight;
      }

      // Function to load the existing conversation transcript for a specific file from the server.
      async function loadTranscript(filename) {
        try {
          const response = await fetch(`/transcript?file=${encodeURIComponent(filename)}`);
          if (response.ok) {
            const data = await response.json();
            document.getElementById('chatBox').innerHTML = '';
            document.getElementById('commitSummaries').innerHTML = '';
            document.getElementById('activeCodingContexts').innerHTML = '';
            data.forEach(msg => {
              if (msg.role.toLowerCase() === 'assistant') {
                const professionalMessage = extract_professional_message(msg.content);
                appendMessage(msg.role, professionalMessage);
                const commit = extract_commit_summary(msg.content);
                if (commit) {
                  appendCommitSummary(commit);
                }
              } else {
                appendMessage(msg.role, msg.content);
              }
            });
            scrollToBottom(chatBox);
            scrollToBottom(commitSummaries);
          }
          // Load coding contexts
          const contextsResponse = await fetch('/coding_contexts');
          if (contextsResponse.ok) {
            const contextsData = await contextsResponse.json();
            activeCodingContexts.innerHTML = ""; // Prevent duplication
            if (contextsData && contextsData.length > 0) {
              contextsData.forEach(ctx => {
                appendCodingContext(ctx);
              });
              scrollToBottom(activeCodingContexts);
            }
          }
        } catch (e) {
          console.error('Error loading transcript or coding contexts:', e);
        }
      }

      // Function to extract commit summary
      function extract_commit_summary(text) {
        const regex = /^Commit Summary:\s*(.+)/m;
        const match = text.match(regex);
        return match ? match[1].trim() : null;
      }

      // Function to extract the professional message before the code block.
      function extract_professional_message(content) {
        const regex = /^(.*?)```/s;
        const match = content.match(regex);
        return match ? match[1].trim() : content.trim();
      }

      // Listen for Ctrl+Enter to submit the form.
      function setupEventListeners() {
        const promptInput = document.getElementById("promptInput");
        const chatForm = document.getElementById("chatForm");
        const throbber = document.getElementById("throbber");
        const chatBox = document.getElementById("chatBox");
        const commitSummaries = document.getElementById("commitSummaries");
        const activeCodingContexts = document.getElementById("activeCodingContexts");

        promptInput.addEventListener("keydown", function(e) {
          if (e.ctrlKey && e.key === "Enter") {
            e.preventDefault();
            chatForm.dispatchEvent(new Event("submit", {cancelable: true}));
          }
        });

        chatForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!activeFile) return;
          const prompt = promptInput.value.trim();
          if (!prompt) return;
          appendMessage("User", prompt);
          scrollToBottom(chatBox);
          promptInput.value = "";
          throbber.style.display = "block";

          try {
            const response = await fetch("/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ prompt: prompt, file: activeFile })
            });
            if (response.ok) {
              const data = await response.json();
              document.getElementById('chatBox').innerHTML = '';
              document.getElementById('commitSummaries').innerHTML = '';
              document.getElementById('activeCodingContexts').innerHTML = '';
              data.forEach(msg => {
                if (msg.role.toLowerCase() === 'assistant') {
                  const professionalMessage = extract_professional_message(msg.content);
                  appendMessage(msg.role, professionalMessage);
                  const commit = extract_commit_summary(msg.content);
                  if (commit) {
                    appendCommitSummary(commit);
                  }
                } else {
                  appendMessage(msg.role, msg.content);
                }
              });
              scrollToBottom(chatBox);
              scrollToBottom(commitSummaries);
              // Reload the source code after AI updates
              await loadSourceCode(activeFile);
              // Reload coding contexts
              await loadCodingContexts();
              // Reload project structure
              await loadProjectStructure();
            } else {
              console.error("Server error:", response.statusText);
            }
          } catch (error) {
            console.error("Fetch error:", error);
          }
          throbber.style.display = "none";
        });
      }

      // Function to load coding contexts
      async function loadCodingContexts() {
        try {
          const response = await fetch('/coding_contexts');
          if (response.ok) {
            const data = await response.json();
            activeCodingContexts.innerHTML = ""; // Prevent duplication
            if (data && data.length > 0) {
              data.forEach(ctx => {
                appendCodingContext(ctx);
              });
              scrollToBottom(activeCodingContexts);
            }
          }
        } catch (e) {
          console.error('Error loading coding contexts:', e);
        }
      }

      // Function to load the existing source code content for a specific file into CodeMirror
      async function loadSourceCode(filename) {
        try {
          const response = await fetch(`/source?file=${encodeURIComponent(filename)}`);
          if (response.ok) {
            const data = await response.json();
            document.getElementById('sourceCode').value = data.content;
            if (editor) {
              editor.setValue(data.content);
            }
          }
        } catch (e) {
          console.error('Error loading source code:', e);
        }
      }

      // Modal functionality
      function openNewFileModal() {
        const modal = document.getElementById("newFileModal");
        modal.style.display = "block";
      }

      function closeNewFileModal() {
        const modal = document.getElementById("newFileModal");
        modal.style.display = "none";
        document.getElementById("newFileName").value = "";
      }

      async function createNewFile() {
        const fileName = document.getElementById("newFileName").value.trim();
        if (!fileName) {
          alert("File name cannot be empty.");
          return;
        }
        const response = await fetch("/create_file", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ file: fileName })
        });
        const data = await response.json();
        if (data.success) {
          closeNewFileModal();
          await loadProjectStructure();
        } else {
          alert("Error creating file: " + data.error);
        }
      }

      // Close modal when clicking outside of it
      window.onclick = function(event) {
        const modal = document.getElementById("newFileModal");
        if (event.target == modal) {
          closeNewFileModal();
        }
      }

      // On startup, load the project structure, initialize CodeMirror, and set up event listeners.
      window.onload = function() {
        initializeCodeMirror();
        loadProjectStructure();
        setupEventListeners();
      };
    </script>
  </head>
  <body>
    <div id="container">
      <!-- Left Column - Project Browser -->
      <div id="projectBrowser">
        <h2>Project Browser</h2>
        <!-- New File Button will be inserted here dynamically -->
        <!-- Project structure will be loaded here dynamically -->
      </div>
      <!-- New File Modal -->
      <div id="newFileModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeNewFileModal()">&times;</span>
          <h3>Create New File</h3>
          <input type="text" id="newFileName" placeholder="Enter file name...">
          <button onclick="createNewFile()">Create</button>
          <button class="cancel" onclick="closeNewFileModal()">Cancel</button>
        </div>
      </div>
      <!-- Middle Column - Active Coding Contexts, Tabs, Source Code Editor and Chat -->
      <div id="mainContent">
        <div id="activeCodingContextsContainer">
          <div id="activeCodingContexts">
            <!-- Coding contexts will be loaded here as badges -->
          </div>
        </div>
        <div id="tabs">
          <!-- Tabs will be dynamically added here -->
        </div>
        <div id="sourceCodeContainer">
          <h2>Source Code Editor</h2>
          <textarea id="sourceCode" readonly></textarea>
        </div>
        <div id="chatContainer">
          <div id="chatBox">
            <!-- Existing conversation will be loaded here -->
          </div>
          <div id="throbber"></div>
          <form id="chatForm">
            <textarea id="promptInput" rows="3" placeholder="Enter your prompt here..."></textarea><br>
            <input type="submit" value="Submit">
          </form>
        </div>
      </div>
      <!-- Right Column - Commit Summaries -->
      <div id="commitSummariesContainer">
        <h2>Commit Summaries</h2>
        <div id="commitSummaries">
          <!-- Commit summaries will be loaded here -->
        </div>
      </div>
    </div>
  </body>
</html>